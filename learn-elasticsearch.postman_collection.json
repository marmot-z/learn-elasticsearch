{
	"info": {
		"_postman_id": "44fc8ce7-60d0-4c05-8fd9-c658350e939f",
		"name": "learn-elasticsearch",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "8461921"
	},
	"item": [
		{
			"name": "install",
			"item": [
				{
					"name": "get elasticsearch version",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// 验证 elasticsearch 是否启动成功",
									"pm.test('elasticsearch start successful', function() {",
									"    let body = pm.response.json();",
									"    let version = pm.collectionVariables.get('esVersion');",
									"",
									"    return pm.response.status == 200 &&",
									"            body.version.name === version;",
									"});"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"let body = pm.request.body.raw;",
									"",
									"console.log(body);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{esHost}}",
							"host": [
								"{{esHost}}"
							]
						},
						"description": "### install elasticsearch\n\n-通过 [start.sh](../start.sh) 在 docker 中启动 ElasticSearch，然后发送 `get elasticsearch version` 请求，观察 Tests  是否成功。"
					},
					"response": []
				}
			],
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"type": "text/javascript",
						"exec": [
							""
						]
					}
				},
				{
					"listen": "test",
					"script": {
						"type": "text/javascript",
						"exec": [
							""
						]
					}
				}
			]
		},
		{
			"name": "document",
			"item": [
				{
					"name": "create document",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"let asyncSeries = eval(pm.globals.get(\"asyncSeries\"));",
									"let getDocumentById = eval(pm.globals.get(\"getDocumentById\"));",
									"let deleteIndex = eval(pm.globals.get(\"deleteIndex\"));",
									"let body = pm.response.json();",
									"",
									"asyncSeries([",
									"    (cb) => getDocumentById({indexName: 'users',id: 1}, cb),",
									"    (cb) => deleteIndex('users', cb)",
									"], (err, results) => {",
									"    if (err) throw err;",
									"",
									"    pm.test('create document successful', function() {",
									"        pm.expect(results[0]._id).eq('1');",
									"        pm.expect(results[0].found).eq(true);",
									"    });",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"user\": \"Mike\",\n    \"post_date\": \"2019-04-15T14:12:12\",\n    \"message\": \"trying out kibana\"\n}"
						},
						"url": {
							"raw": "{{esHost}}/users/_doc/1",
							"host": [
								"{{esHost}}"
							],
							"path": [
								"users",
								"_doc",
								"1"
							]
						},
						"description": "### create document\n\n演示如何创建文档，如果文档对应的索引不存在，则根据文档内容自动推导索引字段类型进行创建"
					},
					"response": []
				},
				{
					"name": "index document",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"let asyncSeries = eval(pm.globals.get(\"asyncSeries\"));",
									"let createDocument = eval(pm.globals.get(\"createDocument\"));",
									"",
									"asyncSeries([",
									"    (cb) => createDocument({",
									"        indexName: 'users',",
									"        doc: {",
									"            \"user\": \"Mike\",",
									"            \"post_date\": \"2019-04-15T14:12:12\",",
									"            \"message\": \"trying out kibana\"",
									"        },",
									"        id: 1",
									"    }, cb)",
									"], (err, res) => {",
									"    if (err) throw err;",
									"",
									"    console.log(`创建文档 ${res ? '成功' : '失败'}`);",
									"});"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"let asyncSeries = eval(pm.globals.get(\"asyncSeries\"));",
									"let getDocumentById = eval(pm.globals.get(\"getDocumentById\"));",
									"let deleteIndex = eval(pm.globals.get(\"deleteIndex\"));",
									"",
									"asyncSeries([",
									"    (cb) => getDocumentById({indexName: 'users',id: 1}, cb),",
									"    (cb) => deleteIndex('users', cb)",
									"], (err, results) => {",
									"    if (err) throw err;",
									"",
									"    let doc = results[0];",
									"",
									"    pm.test('index document successful', function() {",
									"        pm.expect(doc._version).eq(2);",
									"        pm.expect(doc._source.user).eq('Lucy');",
									"        // 不保留文档原先字段内容",
									"        pm.expect(doc._source.message).is.undefined;",
									"    });",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "PUT",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"user\": \"Lucy\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{esHost}}/users/_doc/1",
							"host": [
								"{{esHost}}"
							],
							"path": [
								"users",
								"_doc",
								"1"
							]
						},
						"description": "### index document\n\nindex 作用：\n\n- 如果文档不存在，则创建文档\n- 如果文档存在，则删除旧文档，然后创建新文档，并将_version +1\n    \nindex 与 update 区别：index 会覆盖原先的文档，而 update 只会更新部分字段"
					},
					"response": []
				},
				{
					"name": "update document",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"let asyncSeries = eval(pm.globals.get(\"asyncSeries\"));",
									"let createDocument = eval(pm.globals.get(\"createDocument\"));",
									"",
									"asyncSeries([",
									"    (cb) => createDocument({",
									"        indexName: 'users',",
									"        doc: {",
									"            \"user\": \"Mike\",",
									"            \"post_date\": \"2019-04-15T14:12:12\",",
									"            \"message\": \"trying out kibana\"",
									"        },",
									"        id: 1",
									"    }, cb)",
									"], (err, res) => {",
									"    if (err) throw err;",
									"",
									"    console.log(`创建文档 ${res ? '成功' : '失败'}`);",
									"});"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"let asyncSeries = eval(pm.globals.get(\"asyncSeries\"));",
									"let getDocumentById = eval(pm.globals.get(\"getDocumentById\"));",
									"let deleteIndex = eval(pm.globals.get(\"deleteIndex\"));",
									"",
									"asyncSeries([",
									"    (cb) => getDocumentById({indexName: 'users',id: 1}, cb),",
									"    (cb) => deleteIndex('users', cb)",
									"], (err, results) => {",
									"    if (err) throw err;",
									"",
									"    let doc = results[0];",
									"",
									"    pm.test('update document successful', function() {",
									"        pm.expect(doc._version).eq(2);",
									"        pm.expect(doc._source.user).eq('Lucy');",
									"        // 保留文档原先字段内容",
									"        pm.expect(doc._source.message).eq('trying out kibana');",
									"    });",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"doc\": {\n        \"user\": \"Lucy\"\n    }\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{esHost}}/users/_update/1",
							"host": [
								"{{esHost}}"
							],
							"path": [
								"users",
								"_update",
								"1"
							]
						},
						"description": "### update document\nupdate 只会更新文档对应的字段，其他未更新的字段内容不会变化，并将 _version +1"
					},
					"response": []
				},
				{
					"name": "get document",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"let asyncSeries = eval(pm.globals.get(\"asyncSeries\"));",
									"let createDocument = eval(pm.globals.get(\"createDocument\"));",
									"",
									"asyncSeries([",
									"    (cb) => createDocument({",
									"        indexName: 'users',",
									"        doc: {",
									"            \"user\": \"Mike\",",
									"            \"post_date\": \"2019-04-15T14:12:12\",",
									"            \"message\": \"trying out kibana\"",
									"        },",
									"        id: 1",
									"    }, cb)",
									"], (err, res) => {",
									"    if (err) throw err;",
									"",
									"    console.log(`创建文档 ${res ? '成功' : '失败'}`);",
									"});"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"let asyncSeries = eval(pm.globals.get(\"asyncSeries\"));",
									"let deleteIndex = eval(pm.globals.get(\"deleteIndex\"));",
									"let body = pm.response.json();",
									"",
									"asyncSeries([",
									"    (cb) => deleteIndex('users', cb)",
									"], (err, results) => {",
									"    if (err) throw err;",
									"",
									"    pm.test('get document(1) successful', function() {",
									"        pm.expect(body.found).eq(true);",
									"        pm.expect(body._source.user).eq('Mike');",
									"    });",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{esHost}}/users/_doc/1",
							"host": [
								"{{esHost}}"
							],
							"path": [
								"users",
								"_doc",
								"1"
							]
						}
					},
					"response": []
				},
				{
					"name": "delete document",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"let asyncSeries = eval(pm.globals.get(\"asyncSeries\"));",
									"let createDocument = eval(pm.globals.get(\"createDocument\"));",
									"",
									"asyncSeries([",
									"    (cb) => createDocument({",
									"        indexName: 'users',",
									"        doc: {",
									"            \"user\": \"Mike\",",
									"            \"post_date\": \"2019-04-15T14:12:12\",",
									"            \"message\": \"trying out kibana\"",
									"        },",
									"        id: 1",
									"    }, cb)",
									"], (err, res) => {",
									"    if (err) throw err;",
									"",
									"    console.log(`创建文档 ${res ? '成功' : '失败'}`);",
									"});"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"let asyncSeries = eval(pm.globals.get(\"asyncSeries\"));",
									"let getDocumentById = eval(pm.globals.get(\"getDocumentById\"));",
									"let deleteIndex = eval(pm.globals.get(\"deleteIndex\"));",
									"",
									"asyncSeries([",
									"    (cb) => getDocumentById({indexName: 'users',id: 1}, cb),",
									"    (cb) => deleteIndex('users', cb)",
									"], (err, results) => {",
									"    if (err) throw err;",
									"",
									"    let doc = results[0];",
									"",
									"    pm.test('delete document successful', function() {",
									"        // document 1 not found",
									"        pm.expect(doc.found).eq(false);",
									"    });",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "DELETE",
						"header": [],
						"url": {
							"raw": "{{esHost}}/users/_doc/1",
							"host": [
								"{{esHost}}"
							],
							"path": [
								"users",
								"_doc",
								"1"
							]
						}
					},
					"response": []
				},
				{
					"name": "msearch",
					"request": {
						"method": "GET",
						"header": []
					},
					"response": []
				},
				{
					"name": "bulk",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"let asyncSeries = eval(pm.globals.get(\"asyncSeries\"));",
									"let getDocumentById = eval(pm.globals.get(\"getDocumentById\"));",
									"let deleteIndex = eval(pm.globals.get(\"deleteIndex\"));",
									"let body = pm.response.json();",
									"",
									"asyncSeries([",
									"    (cb) => getDocumentById({indexName: 'test', id: 1}, cb),",
									"    (cb) => getDocumentById({indexName: 'test', id: 3}, cb),",
									"    (cb) => deleteIndex('test', cb)",
									"], (err, results) => {",
									"    if (err) throw err;",
									"",
									"    let doc1 = results[0];",
									"    let doc2 = results[1];",
									"",
									"    pm.test('bulk successful', function() {",
									"        // 创建文档 1 成功并更新",
									"        pm.expect(doc1.found).eq(true);",
									"        pm.expect(doc1._version).eq(2);",
									"        pm.expect(doc1._source.field1).eq('value1');",
									"        pm.expect(doc1._source.field2).eq('value2');",
									"        // 创建文档 3 成功",
									"        pm.expect(doc2.found).eq(true);",
									"",
									"        // 创建文档 1 成功",
									"        pm.expect(body.items[0].index.result).eq('created');",
									"        // 删除文档 2 失败（文档 2 不存在），该操作失败不影响其他操作",
									"        pm.expect(body.items[1].delete.result).eq('not_found');",
									"        // 创建文档 3 成功",
									"        pm.expect(body.items[2].create.result).eq('created');",
									"        // 更新文档 1 成功",
									"        pm.expect(body.items[3].update.result).eq('updated');",
									"    });",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{ \"index\" : { \"_index\" : \"test\", \"_id\" : \"1\" } }\n{ \"field1\" : \"value1\" }\n{ \"delete\" : { \"_id\" : \"2\" } }\n{ \"create\" : { \"_id\" : \"3\" } }\n{ \"field1\" : \"value3\" }\n{ \"update\" : {\"_id\" : \"1\"} }\n{ \"doc\" : {\"field2\" : \"value2\"} }\n",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{esHost}}/test/_bulk",
							"host": [
								"{{esHost}}"
							],
							"path": [
								"test",
								"_bulk"
							]
						},
						"description": "### bulk \nbulk 能同时执行多条命令\n- 部分命令报错不会影响另一部分命令的执行\n- 每条命令使用 \\n 分隔（最后一条命令也要使用 \\n 结尾）\n- 可以指定默认目标索引，没有 _index 参数的命令会使用默认目标索引\n\n官方文档：https://www.elastic.co/guide/en/elasticsearch/reference/7.17/docs-bulk.html"
					},
					"response": []
				},
				{
					"name": "mget",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"let asyncSeries = eval(pm.globals.get(\"asyncSeries\"));",
									"let deleteIndex = eval(pm.globals.get(\"deleteIndex\"));",
									"let body = pm.response.json();",
									"let indexs = ['test1', 'test2', 'test3', 'test4'];",
									"",
									"asyncSeries(",
									"    indexs.map(index => cb => deleteIndex(index, cb)),",
									"    (err, results) => {",
									"        if (err) throw err;",
									"",
									"        pm.test('multi get successful', function() {",
									"            // 验证获取默认索引文档",
									"            pm.expect(body.docs[0].found).eq(true);",
									"            pm.expect(body.docs[0]._source.id).eq(1);",
									"            // 验证获取指定索引文档",
									"            pm.expect(body.docs[1].found).eq(true);",
									"            pm.expect(body.docs[1]._source.id).eq(1);",
									"            // 验证获取指定字段",
									"            pm.expect(body.docs[2].found).eq(true);",
									"            pm.expect(body.docs[2]._source.id).eq(2);",
									"            pm.expect(body.docs[2]._source.age).is.undefined;",
									"            // 验证获取文档失败（文档不存在）",
									"            pm.expect(body.docs[3].found).eq(false);",
									"        });",
									"    }",
									");"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"let asyncSeries = eval(pm.globals.get(\"asyncSeries\"));",
									"let createDocument = eval(pm.globals.get(\"createDocument\"));",
									"let docs = {",
									"    \"test1\": {id: 1, name: \"zhangsan\", age: 18},",
									"    \"test2\": {id: 1, date: '2022-09-21', count: 2},",
									"    \"test3\": {id: 2, name: 'lisi', age: 29},",
									"    \"test4\": {id: 2, date: '2022-09-23', count: 3}",
									"};",
									"",
									"// 创建多个索引多条数据",
									"asyncSeries(",
									"    Object.entries(docs)",
									"    .map(([k, v]) => ",
									"        (cb) => createDocument({",
									"            indexName: k,",
									"            doc: v,",
									"            id: v.id",
									"        }, cb)",
									"    ), ",
									"    (err, res) => {",
									"        if (err) throw err;",
									"",
									"        console.log('数据已创建');",
									"    }",
									");"
								],
								"type": "text/javascript"
							}
						}
					],
					"protocolProfileBehavior": {
						"disableBodyPruning": true
					},
					"request": {
						"method": "GET",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"docs\": [\n        {\n            \"_id\": 1\n        },\n        {\n            \"_id\": 1,\n            \"_index\": \"test2\"\n        },\n        {\n            \"_id\": 2,\n            \"_index\": \"test3\",\n            \"_type\": \"_doc\",\n            \"_source\": [\"id\", \"name\"]\n        },\n        {\n            \"_id\": 3,\n            \"_index\": \"test4\"\n        }\n    ]\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{esHost}}/test1/_mget/",
							"host": [
								"{{esHost}}"
							],
							"path": [
								"test1",
								"_mget",
								""
							]
						},
						"description": "### multi get\n\nmulti get 可以同时获取多条数据\n\n- 指定默认索引\n`GET /test/_mget`  \n- 使用 ids 查询指定 id 的数据  \n```\nGET /test/_mget\n{\n   \"ids\": [\"1\", \"2\"]\n}\n```\n- 使用 docs 获取指定文档\n    - 使用 _source 指定返回字段  \n    - 使用 _index 指定返回字段\n\n官方文档：[https://www.elastic.co/guide/en/elasticsearch/reference/7.17/docs-multi-get.html](https://www.elastic.co/guide/en/elasticsearch/reference/7.17/docs-multi-get.html)"
					},
					"response": []
				}
			],
			"description": "演示如何文档的增删改查：\n\n- 增加(create document)  \n- index(index document)  \n- 更新(update document)  \n- 获取(get document)  \n- 删除(delete document)"
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"const elasticsearchHost = 'http://localhost:9200';",
					"const elasticsearchVersion = '7.17.0';",
					"",
					"// set global varibales",
					"pm.collectionVariables.set('esHost', elasticsearchHost);",
					"pm.collectionVariables.set('esVersion', elasticsearchVersion);",
					"",
					"// set default header",
					"pm.request.headers.add({key: 'Content-type', value: 'application/json'});",
					"",
					"// global functions",
					"// see also: https://www.postman.com/postman/workspace/postman-answers/request/3407886-06011115-e3cf-4711-926c-55a417d530f1",
					"let asyncSeries = (tasks, cb = () => {}) => {",
					"    let _series = function(tasks, cb, currOperation = 0, results = []) {",
					"        // Bail-out condition",
					"        if (currOperation === tasks.length) {",
					"            return cb(null, results);",
					"        }",
					"",
					"        if (typeof tasks[currOperation] !== 'function') {",
					"            return cb(new Error('asyncSeries: Please provide a function'));",
					"        }",
					"",
					"        tasks[currOperation]((err, res) => {",
					"            if (err) {",
					"                return cb(err);",
					"            }",
					"",
					"            results.push(res);",
					"",
					"            // Recursively call the next task in series till we're done executing all the operations",
					"            return _series(tasks, cb, currOperation + 1, results);",
					"        });",
					"    }",
					"",
					"    return _series(tasks, cb);",
					"};",
					"",
					"let deleteIndex = (indexName, callback) => {",
					"   pm.sendRequest({",
					"        url: `${pm.collectionVariables.get('esHost')}/${indexName}`,",
					"        method: 'DELETE'",
					"    }, (err, resp) => {",
					"        if (err) return callback(err);",
					"",
					"        let body = resp.json();",
					"",
					"        callback(null, body.acknowledged);",
					"    });",
					"};",
					"",
					"let createIndex = (options, callback) => {",
					"    pm.sendRequest({",
					"        url: `${pm.collectionVariables.get('esHost')}/${options.indexName}`,",
					"        method: 'PUT',",
					"        body: {",
					"            mode: 'raw',",
					"            raw: JSON.stringify({",
					"                settings: options.settings || {},",
					"                mappings: options.mappings || {}",
					"            })",
					"        }",
					"    }, (err, resp) => {",
					"        if (err) return callback(err);",
					"",
					"        let body = resp.json();",
					"",
					"        callback(null, body.acknowledged);",
					"    });",
					"};",
					"",
					"let createDocument = (options, callback) => {",
					"    pm.sendRequest({",
					"        url: `${pm.collectionVariables.get('esHost')}/${options.indexName}/_doc/${options.id ? options.id : ''}`,",
					"        method: 'POST',",
					"        header: {",
					"            'Content-type': 'application/json'",
					"        },",
					"        body: {",
					"            mode: 'raw',",
					"            raw: JSON.stringify(options.doc)",
					"        }",
					"    }, (err, resp) => {",
					"        if (err) return callback(err);",
					"",
					"        let body = resp.json();",
					"",
					"        callback(null, body.result === 'created');",
					"    });",
					"};",
					"",
					"let getDocumentById = (options, callback) => {",
					"    pm.sendRequest({",
					"        url: `${pm.collectionVariables.get('esHost')}/${options.indexName}/_doc/${options.id}`,",
					"        method: 'GET',",
					"    }, (err, resp) => {",
					"        if (err) return callback(err);",
					"",
					"        callback(null, resp.json());",
					"    });",
					"};",
					"",
					"// set global function",
					"postman.setGlobalVariable('asyncSeries', asyncSeries);",
					"postman.setGlobalVariable('createIndex', createIndex);",
					"postman.setGlobalVariable('deleteIndex', deleteIndex);",
					"postman.setGlobalVariable('createDocument', createDocument);",
					"postman.setGlobalVariable('getDocumentById', getDocumentById);"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	],
	"variable": [
		{
			"key": "esHost",
			"value": ""
		},
		{
			"key": "esVersion",
			"value": ""
		}
	]
}